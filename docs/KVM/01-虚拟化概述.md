# 一、虚拟化概述

## 1.1 什么是虚拟化

简单来说，在计算机技术中，虚拟化就是通过技术手段，创建出虚拟版本的服务器、存储设备、网络设备等。常见的虚拟化技术有：系统虚拟化、存储虚拟化、网络虚拟化、GPU虚拟化、软件虚拟化、硬件支持虚拟化。

其中，**系统虚拟化**为虚拟化技术的核心，通常表现为在**单一系统上运行多个操作系统**。这些操作系统同时运行，又相互独立。通常有以下三种实现方式：

1、纯软件仿真

通过软件模拟完整的硬件环境，来实现虚拟化Guest平台，例如：QEMU、Bochs、PearPC。可模拟X86、ARM、PowerPC等多种CPU，**效率较低。**

2、虚拟化层 ★

大多数虚拟化使用**虚拟机管理程序 Hypervisors**，Hypervisors是一个软件层或子系统，也称VMM（Virtual Machine Monitor 虚拟机监视器）。Hypervisor虚拟化层允许多种操作系统在相同的物理系统中运行，并提供虚拟化的硬件供上层虚拟机使用。

![image-20250210170921726](./01-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%A6%82%E8%BF%B0/image-20250210170921726.png)

3、容器技术

一种新型的轻量级/操作系统虚拟化技术，通过**资源限制（Cgroup）**和**隔离（Namespace）**，将应用程序及其依赖项打包到一个可移植的、轻量级的运行环境中。

## 1.2 虚拟化技术发展史

​	虚拟化技术最早是在1959年的国际信息处理大会上，由Christopher Strachey在他的报告《大型高速计算机时间共享》里第一次提到。

​	从20世纪60年代到20世纪70年代的大型机时代虚拟化技术开始被研究，那个时候比较出名的就是IBM 的Systm/360大型机，因为那个时候的大型机还无法支持现代操作系统的多人多任务，大家使用机器 资源的时候还需要提申请排队来使用。同时那个时候大型机的价格非常昂贵，只有一些大型科研院所、大公司等机构才能使用的起。为此IBM投入了大量的时间和精力来开发分时解决方案（Time sharing System）。

​	实现用户能够同时共享一台大型机的计算资源，来提高机器的资源利用率。因为每个人跑的任务都不一样，你的任务不一定能把机器所有的资源都消耗完，同一时间多余的资源其他人又用不了，那资源就浪费了。如果多个人可以同时使用机器的资源，那每个人平摊下来的机器成本就比单人使用机器资源更低了，大家甚至可以直接去租用资源，而不需要去购买一台昂贵的大型机。这个概念听起来是不是很熟悉？有点像现在云资源的使用模式了。

​	IBM当时开发的这套系统叫做虚拟机监视器（Virtual Machine Monitor，简称VMM），这个软件可以作为计算机硬件层上面的一个软件抽象层，可以把计算机硬件分割成一个或多个虚拟机，可以让多个用户能够同时交互地访问大型机的资源。这技术大大促进了大型机使用成本的降低以及大型机的普及，使得IBM成为了20世纪的IT行业霸主。 

​	20世纪80年代到20世纪90年代，随着大规模集成电路技术的高速发展，计算机开始快速小型化，同时计算机硬件也越来越便宜，让个人计算机得以快速普及，为共享大型计算机资源而生的虚拟化技术开始没落，只在部分高档服务器上存在。这个时候一家小公司都买 的计算机给自己的员工使用，谁还愿意去租用别人的资源？

​	20世纪90年代末，随着x86技术的快速发展，x86平台处理能力与日俱增。1998年Intel针对服务器和工作站推出了专门的至强系列处理器（Xeon），性能极为强大，促进了企业数据中心的发展。但是随着基于X86架构的服务器硬件不断的升级，出现了新的难题：X86服务器的利用率太低，企业数据中心中平均利用率仅为总容量的10%到15%。而且企业通常在每台服务器上只运行一个应用程序，以避免出现应用程序出现故障或漏洞影响同一服务器上其他应用程序可用性。如果企业业务快速发展时，就需要不断采购新的服务器来支撑新的业务需求，物理采购成本和IT管理成本不断攀升，企业急需寻找一个新的保障IT投资最大化利用的解决方案，这个时候虚拟化技术又进入了企业的眼帘。 

​	1999年，VMware公司成立，并于同年在x86平台上推出了可以流畅运行的虚拟化软件VMware系列，旨在解决X86服务器利用率低下的问题，将X86系统转变成通用的共享硬件基础架构。而同一年，伦敦剑桥大学的Ian Pratt和Keir Fraser在一 个叫做XenoServer的计算项目中，开发了Xen虚拟机。Xen后面被思杰（Citrix）公司收购，推出了我们熟悉的 XenServer。

​	2003年 Xen在2002年被正式开源后，在2003年面世，同年微软收购Connectix获得虚拟化技术，并将它集成到自己的WindowsServer系列，即我们熟悉的Hyper-V. 

​	2005年 Intel发布新的志强7000系列处理器，x86平台历史上第一个硬件辅助虚拟化技术-VT（VanderpoolTechnology）诞生。

## 1.3 虚拟化的分类方式

虚拟化可以根据不同的维度进行分类，以下是常见的几种分类方式：

**按实现方式分类**

- **无硬件辅助的全虚拟化**：Hypervisor运行在Ring 0。不需要修改客户机操作系统，虚拟机监控程序**完全模拟底层硬件**，QEMU、Virtual PC、VMware Workstation
- **半虚拟化**：Hypervisor运行 Ring 0，Guest OS不能直接运行在Ring0，需要对Kernel进行修改，将运行在Ring 0上的，指令转为调用Hypervisor。需要对客户机操作系统进行修改，使其与虚拟机监控程序协作，Xen。
- **硬件辅助的全虚拟化**：Intel VT和AMD-V创建一个新的Ring -1单独给Hypervisor使用，Guest OS可以直接使用Ring 0而无需修改。利用硬件支持（如Intel-VT或AMD-V）来提高虚拟化的性能，VMware ESXi、KVM、Xen3.0。

![image-20250210212452547](./01-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%A6%82%E8%BF%B0/image-20250210212452547.png)

**按Hypervisor类型分类**

- **Type Ⅰ Hypervisor（裸金属虚拟化）**：直接运行在物理硬件上，管理虚拟客户机操作系统。例如，Xen和ESXi。
- **Type Ⅱ Hypervisor（寄宿虚拟化）**：运行在宿主机操作系统中，依赖宿主机操作系统的资源管理。例如，KVM、VMware Workstation和VirtualBox。

![image-20250210211445454](./01-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%A6%82%E8%BF%B0/image-20250210211445454.png)

# 二、KVM概述

## 2.1 KVM的历史

KVM最初由以色列的公司Qumranet开发。

- 2006年10月，在完成基本功能、动态迁移、主要的性能优化后，正式宣布了KVM的诞生

- 2007年2月发布的内核2.6.20中，开始正式包括了KVM

2008年9月，被Redhat 1.7亿美元收购

- RHEL5.4，在集成Xen的基础上，又将KVM添加进来
- 2011年11月，RHEL6使用KVM彻底替换了Xen

QEMU：

- QEMU是一个通用的开源的硬件模拟器，可以模拟多种硬件

- QEMU-KVM从分支到与主干合并，QEMU成为KVM在用户空间的管理工具

## 2.2 KVM体系结构

KVM主要由三个组件构成

1. KVM

   KVM属于硬件辅助的虚拟化类型，依赖于CPU提供的硬件虚拟化功能。它主要是和CPU打交道，用来处理⼀些特殊硬件指令相关的操作，初始化CPU硬件，打开虚拟化模式，负责CPU、内存、中断控制器、时钟等等，以支持虚拟机的运行。

2. QEMU

   如果要运行虚拟机操作系统，光有CPU还是不够的，还需要网卡、磁盘、IO设备等等。这些设备交由QEMU纯软件模拟出。

![image-20250210213919690](./01-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%A6%82%E8%BF%B0/image-20250210213919690.png)

3. Libvirt

   到这个时候为止，能够实现虚拟机创建的技术已经有很多了，例如kvm、xen、hyper-v等等，那么如何实现对这些VMM创建的虚拟机进行统⼀管理呢？

   而Libvirt就是这样⼀款工具，它是由红帽开发的，用来提供⼀个通用、稳定的抽象软件层，方便整个系统上统⼀管理节点上运行的虚拟机，不管你这个虚拟机是kvm创建还是xen、hyper-v等VMM创建的， 都可以使用Libvirt提供的命令行工具virsh来进行统⼀管理，同时它还对外提供支持各种编程语言的API接口，让你可以开发出自己的虚拟机管理平台，[KVM社区](http://www.linux-kvm.org/page/Management_Tools)推荐了许多管理工具，比如：[Ovirt](https://www.ovirt.org/)：功能强大，是Redhat虚拟化管理平台RHEV的开源版本，[WebVirtMgr](https://www.webvirtmgr.net/)：virt-manager的Web模式的替代品，[Convirt](http://www.convirture.com/)：分开源版本和商业版本。

![image-20250210214959724](./01-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%A6%82%E8%BF%B0/image-20250210214959724.png)